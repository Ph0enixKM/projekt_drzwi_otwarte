---
# tasks file for users
- name: Create remote_access group
  group: 
    name: remote_access 
    state: present

- name: Add users
  user: 
    name: "{{ item.login }}"
    groups: "users{% if 'groups' in item %},{{ item.groups|join(',') }}{% endif %}"
    shell: "/bin/bash" 
    append: yes 
    comment: "{{ item.fullname }}" 
    password: "{{ item.password }}"
  with_items: "{{ users }}"

- name: Setup authorized keys for users
  authorized_key: 
    user: "{{ item.login }}" 
    key: "{{ item.pubkey }}"
  with_items: "{{ users }}"

- name: Install sshd_banner
  template: 
    src: etc/ssh/sshd_banner 
    dest: /etc/ssh/sshd_banner 
    mode: 0644 
    owner: root 
    group: root
  when: banner is defined

- name: Install sshd_config
  template: 
    src: "etc/ssh/sshd_config" 
    dest: "/etc/ssh/sshd_config" 
    mode: "0644" 
    owner: "root" 
    group: "root"

- name: Allow sudo_group group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: "^%sudo"
    line: "%sudo ALL=(ALL) NOPASSWD: ALL"
    validate: '/usr/sbin/visudo -cf %s'